# MinIO tenant with cert-manager [![Slack](https://slack.min.io/slack?type=svg)](https://slack.min.io)

This document explains how to deploy a MinIO tenant using certificates generated by [cert-manager](https://cert-manager.io/) 
using a self-signed issuer.

On a Kubernetes cluster, Certificate Manager requires a global level `Cluster Issuer` to generate intermediary Issuers and certificates. 

At the namespace level, Cert Manager issues certificates derived from an `Issuer`.

The main difference between a `Cluster Issuer` and a `Issuer` is that `Cluster Issuer` can Issue certificates for several namespaces and an `Issuer` can only issue them in a single namespace.

To learn more about Cert Manager Issuers refer to their documentation https://cert-manager.io/docs/concepts/issuer/.

For example below is a logical view of a Kubernetes cluster:

![Cert-manager-namespaces.png](images%2FCert-manager-namespaces.png)

This cluster contains 4 namespaces:

- minio-operator
- tenant-1
- tenant-2
- other-namespace

Each namespace contains pods and services. This environment requires a Cert Manager
to issue certificates so the different services and pods can trust each others' certificates. 
To do this, create a global root issuer and an intermediary issuer in each tenant namespace:

![Cert-manager Issuers.png](images%2FCert-manager%20Issuers.png)

Cert Manager is installed in the `cert-manager` namespace. 

Root Issuer is created in the default namespace.

Is recommended to create a local `Issuer` in each tenant namespace, and as well in the minio-operator namespace.

> [!NOTE]  
> This guide uses a self-signed Cluster Issuer. You can also use [other Issuers supported by Cert Manager](https://cert-manager.io/docs/configuration/issuers/).
> The main difference is that you must provide the `Issuer` CA certificate to minio, instead of the `root` CA used in this guide.

## Getting Started

### Prerequisites

- Kubernetes version `+v1.21`. While cert-manager
  supports [earlier K8s versions](https://cert-manager.io/docs/installation/supported-releases/), MinIO Operator requires 1.21 or later.
- MinIO Operator installed
- [kustomize](https://kustomize.io/) installed
- `kubectl` access to your `k8s` cluster
- [cert-manager](https://cert-manager.io/docs/releases/release-notes/release-notes-1.12/) 1.12.X (preferred) or later installed.

## Setup Cert-manager

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.12.9/cert-manager.yaml
```

### Create Cluster Self-signed root Issuer
The root Issuer is the root level certificate all other certificates are derived from. 
Request Cert Manager to generate this by creating a `ClusterIssuer` resource:

```yaml
# selfsigned-root-clusterissuer.yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-root
spec:
  selfSigned: {}
```

```shell
kubectl apply -f selfsigned-root-clusterissuer.yaml
```

### Create tenant-1 namespace CA intermediary Issuer

Create the Intermediary Certificate Authority (CA) certificate used to issue certificates for MinIO.

First create the `Issuer`:

```yaml
# tenant-1-ca-issuer.yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: tenant-1-ca-issuer
  namespace: tenant-1
spec:
  ca:
    secretName: tenant-1-ca-secret
```

```shell
kubectl apply -f tenant-1-ca-issuer.yaml
```

Next, request a Certificate with `isCA: true` specified. This is our intermediary CA.

```yaml
# tenant-1-ca-certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: tenant-1-ca-certificate
  namespace: tenant-1
spec:
  isCA: true
  commonName: tenant-1-ca
  secretName: tenant-1-ca-secret
  duration: 70128h # 8y
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-root
    kind: ClusterIssuer
    group: cert-manager.io
```

```shell
kubectl apply -f tenant-1-ca-certificate.yaml
```

## Deploy the tenant 

### Create a certificate for Tenant

Request `cert-manager` issue a new certificate based on the following internal domains:

```shell
minio.<namespace>
minio.<namespace>.svc
minio.<namespace>.svc.<cluster domain>
*.<tenant-name>-hl.<namespace>.svc.<cluster domain>
*.<namespace>.svc.<cluster domain>
```

> [!IMPORTANT]
> Replace `<tenant-name>`, `<namespace>` and `<cluster domain>` with the actual values for your MinIO tenant. Note the 3 key element names:
> * `tenant-name` is the name provided to your tenant in the `metadata.name` of the Tenant YAML. For this example it is `myminio`.
> * `namespace` is the namespace where the tenant is created, the `metadata.namespace` notes that in the Tenant YAML. For this example it is `tenant-1`.
> * `cluster domain` is the DNS assigned in your Kubernetes cluster. Typically this is `cluster.local`, check on your coredns configuration for the correct value for your Kubernetes cluster. For example, the output of `kubectl get configmap coredns -n kube-system -oyaml | yq ".data"` can vary depending on the Kubernetes distribution (Openshift, Rancher, EKS, etc.)

Create a `Certificate` for the domains mentioned above:

```yaml
# tenant-1-minio-certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: tenant-certmanager-cert
  namespace: tenant-1
spec:
  dnsNames:
    - "minio.tenant-1"
    - "minio.tenant-1.svc"
    - '*.minio-tenant-1.svc.cluster.local'
    - '*.minio.tenant-1.svc.cluster.local'
    - '*.myminio-hl.tenant-1.svc.cluster.local'
  secretName: tenant-certmanager-tls
  issuerRef:
    name: tenant-certmanager-issuer
```

```shell
kubectl apply -f tenant-1-minio-certificate.yaml
```

### Setup tenant to use certificate created by cert-manager 

In the tenant spec, do the following:

* Disable `spec.requestAutoCert`. This instructs Operator to not attempt to issue certificates and instead rely on Cert Manager to provide them in a secret.
* Reference the Secret containing the TLS certificate from the previous step in `spec.externalCertSecret`.

The `Tenant` section should look like the following:

```yaml
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: myminio
  namespace: tenant-1
spec:
  ## Disable default tls certificates.
  requestAutoCert: false
  ## Use certificates generated by cert-manager.
  externalCertSecret:
    - name: tenant-certmanager-tls
      type: cert-manager.io/v1
```

## Trust CA in MinIO Operator

MinIO Operator can trust as many CA certificates as provided. To do this, create a secret with the prefix `operator-ca-tls-` 
followed by an identifier in the `minio-operator` namespace. In this example the secret name is `operator-ca-tls-tenant-1`.

MinIO Operator will mount and trust all certificates issued by the provided CA's. This is required because
Operator performs MinIO health checks using the health cluster endpoint. (For more details, see https://min.io/docs/minio/Kubernetes/upstream/operations/monitoring/healthcheck-probe.html#cluster-write-quorum).

If Operator is not correctly configured to trust the MinIO Certificate (or its CA), you will see the following error message in the Operator Pod logs:

```error
Failed to get cluster health: Get "https://minio.tenant-1.svc.cluster.local/minio/health/cluster":
x509: certificate signed by unknown authority
```

### Create `operator-ca-tls-tenant-1` secret

Copy the cert-manager generated CA certificate into the minio-operator namespace. This allows Operator to trust the cert-manager issued CA and its derivatives.

Create a `ca.crt` file containing the CA:
```sh
kubectl get secrets -n tenant-1 tenant-1-ca-tls -o=jsonpath='{.data.ca\.crt}' | base64 -d > ca.crt
```

Create the secret:
```sh
kubectl create secret generic operator-ca-tls-tenant1 --from-file=ca.crt -n minio-operator
```

Restart `minio-operator`:
```sh
kubectl rollout restart deployment.apps/minio-operator -n minio-operator
```
